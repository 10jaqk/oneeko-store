<section class="collection-page py-16">
  <div class="container">
    <div class="collection-page__content">
        <!-- Toolbar -->
        <div class="collection-toolbar">
          <button type="button" class="filter-button" data-filter-toggle>
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
              <path d="M2 4h14M4 9h10M7 14h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Filter & Sort</span>
            <svg class="filter-button__arrow" width="12" height="12" viewBox="0 0 12 12" fill="none">
              <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <!-- Filter Dropdown -->
          <div class="filter-dropdown" data-filter-dropdown>
            <div class="filter-dropdown__content">
              <div class="filter-dropdown__group">
                <label for="PriceFilter" class="filter-dropdown__label">Price Range</label>
                <select id="PriceFilter" name="price_filter" class="filter-dropdown__select" data-price-filter>
                  <option value="">All Prices</option>
                  <option value="0-25">Under $25</option>
                  <option value="25-50">$25 - $50</option>
                  <option value="50-100">$50 - $100</option>
                  <option value="100-">Over $100</option>
                </select>
              </div>

              <div class="filter-dropdown__group">
                <label for="AvailabilityFilter" class="filter-dropdown__label">Availability</label>
                <select id="AvailabilityFilter" name="availability_filter" class="filter-dropdown__select" data-availability-filter>
                  <option value="">All</option>
                  <option value="in-stock">In Stock</option>
                  <option value="out-of-stock">Out of Stock</option>
                </select>
              </div>

              <div class="filter-dropdown__group">
                <label for="SortBy" class="filter-dropdown__label">Sort By</label>
                <select id="SortBy" name="sort_by" class="filter-dropdown__select" data-sort-select>
                  <option value="manual">Featured</option>
                  <option value="best-selling">Best Selling</option>
                  <option value="title-ascending">A-Z</option>
                  <option value="title-descending">Z-A</option>
                  <option value="price-ascending">Price: Low to High</option>
                  <option value="price-descending">Price: High to Low</option>
                  <option value="created-ascending">Date: Old to New</option>
                  <option value="created-descending">Date: New to Old</option>
                </select>
              </div>

              <div class="filter-dropdown__actions">
                <button type="button" class="btn btn-outline" data-filter-reset>Clear All</button>
                <button type="button" class="btn btn-primary" data-filter-apply>Apply</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Product Grid -->
        {%- if collection.products.size > 0 -%}
          <div class="product-grid grid grid-cols-2 md:grid-cols-4">
            {%- for product in collection.products -%}
              {%- render 'product-card', product: product -%}
            {%- endfor -%}
          </div>

          <!-- Pagination -->
          {%- if paginate.pages > 1 -%}
            <div class="pagination">
              {%- if paginate.previous -%}
                <a href="{{ paginate.previous.url }}" class="pagination__item pagination__prev">
                  {%- render 'icon-arrow-right' -%}
                </a>
              {%- endif -%}

              {%- for part in paginate.parts -%}
                {%- if part.is_link -%}
                  <a href="{{ part.url }}" class="pagination__item">{{ part.title }}</a>
                {%- else -%}
                  {%- if part.title == paginate.current_page -%}
                    <span class="pagination__item pagination__item--current">{{ part.title }}</span>
                  {%- else -%}
                    <span class="pagination__item">{{ part.title }}</span>
                  {%- endif -%}
                {%- endif -%}
              {%- endfor -%}

              {%- if paginate.next -%}
                <a href="{{ paginate.next.url }}" class="pagination__item pagination__next">
                  {%- render 'icon-arrow-right' -%}
                </a>
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- else -%}
          <div class="collection-page__empty">
            <p>{{ 'collections.general.no_products' | t }}</p>
          </div>
        {%- endif -%}
    </div>
  </div>
</section>

<style>
  .collection-page__content {
    width: 100%;
  }

  /* Toolbar */
  .collection-toolbar {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    margin-bottom: var(--spacing-6);
    padding-bottom: var(--spacing-4);
    border-bottom: 1px solid var(--color-border);
  }

  /* Filter Button */
  .filter-button {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-3) var(--spacing-5);
    background-color: var(--color-bg-primary);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .filter-button:hover {
    border-color: var(--color-brand-primary);
    color: var(--color-brand-primary);
  }

  .filter-button svg {
    transition: transform var(--transition-base);
  }

  .filter-button.active .filter-button__arrow {
    transform: rotate(180deg);
  }

  /* Filter Dropdown */
  .filter-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background-color: var(--color-bg-primary);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all var(--transition-base);
    z-index: 100;
    min-width: 320px;
  }

  .filter-dropdown.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .filter-dropdown__content {
    padding: var(--spacing-5);
  }

  .filter-dropdown__group {
    margin-bottom: var(--spacing-4);
  }

  .filter-dropdown__group:last-of-type {
    margin-bottom: var(--spacing-5);
  }

  .filter-dropdown__label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-2);
  }

  .filter-dropdown__select {
    width: 100%;
    padding: var(--spacing-3);
    font-size: var(--font-size-base);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background-color: var(--color-bg-primary);
    cursor: pointer;
    transition: border-color var(--transition-base);
  }

  .filter-dropdown__select:focus {
    outline: none;
    border-color: var(--color-brand-primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .filter-dropdown__actions {
    display: flex;
    gap: var(--spacing-3);
    padding-top: var(--spacing-4);
    border-top: 1px solid var(--color-border);
  }

  .filter-dropdown__actions .btn {
    flex: 1;
  }

  @media (max-width: 640px) {
    .collection-toolbar {
      justify-content: center;
    }

    .filter-dropdown {
      left: 0;
      right: 0;
      min-width: auto;
    }
  }

  /* Pagination */
  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-2);
    margin-top: var(--spacing-8);
  }

  .pagination__item {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
    padding: var(--spacing-2) var(--spacing-3);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    color: var(--color-text-primary);
    transition: all var(--transition-base);
    text-decoration: none;
  }

  .pagination__item:hover {
    border-color: var(--color-brand-primary);
    color: var(--color-brand-primary);
  }

  .pagination__item--current {
    background-color: var(--color-brand-primary);
    color: white;
    border-color: var(--color-brand-primary);
  }

  .pagination__prev svg {
    transform: rotate(180deg);
  }

  .pagination__item svg {
    width: 16px;
    height: 16px;
  }

  /* Empty State */
  .collection-page__empty {
    text-align: center;
    padding: var(--spacing-12) var(--spacing-4);
    font-size: var(--font-size-lg);
    color: var(--color-text-secondary);
  }

</style>

<script>
  // Collection Filter & Sort
  (function() {
    const filterToggle = document.querySelector('[data-filter-toggle]');
    const filterDropdown = document.querySelector('[data-filter-dropdown]');
    const filterApply = document.querySelector('[data-filter-apply]');
    const filterReset = document.querySelector('[data-filter-reset]');
    const priceFilter = document.querySelector('[data-price-filter]');
    const availabilityFilter = document.querySelector('[data-availability-filter]');
    const sortSelect = document.querySelector('[data-sort-select]');
    const productCards = document.querySelectorAll('.product-card');

    // Toggle dropdown
    if (filterToggle) {
      filterToggle.addEventListener('click', function() {
        filterToggle.classList.toggle('active');
        filterDropdown.classList.toggle('active');
      });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (filterToggle && filterDropdown &&
          !filterToggle.contains(e.target) &&
          !filterDropdown.contains(e.target)) {
        filterToggle.classList.remove('active');
        filterDropdown.classList.remove('active');
      }
    });

    // Apply filters (client-side filtering)
    function applyFilters() {
      const priceRange = priceFilter ? priceFilter.value : '';
      const availability = availabilityFilter ? availabilityFilter.value : '';

      productCards.forEach(card => {
        let showCard = true;

        // Price filtering
        if (priceRange) {
          const price = parseInt(card.dataset.price) / 100; // Convert cents to dollars
          const [min, max] = priceRange.split('-').map(v => v ? parseInt(v) : null);

          if (min !== null && max !== null) {
            showCard = price >= min && price < max;
          } else if (min !== null && max === null) {
            showCard = price >= min;
          }
        }

        // Availability filtering
        if (showCard && availability) {
          const isAvailable = card.dataset.available === 'true';

          if (availability === 'in-stock') {
            showCard = isAvailable;
          } else if (availability === 'out-of-stock') {
            showCard = !isAvailable;
          }
        }

        // Show/hide card
        if (showCard) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });

      // Close dropdown after applying
      if (filterToggle && filterDropdown) {
        filterToggle.classList.remove('active');
        filterDropdown.classList.remove('active');
      }
    }

    // Apply button
    if (filterApply) {
      filterApply.addEventListener('click', applyFilters);
    }

    // Reset filters
    if (filterReset) {
      filterReset.addEventListener('click', function() {
        if (priceFilter) priceFilter.value = '';
        if (availabilityFilter) availabilityFilter.value = '';
        if (sortSelect) sortSelect.value = 'manual';
        applyFilters();
      });
    }

    // Sort functionality
    if (sortSelect) {
      sortSelect.addEventListener('change', function() {
        const url = new URL(window.location.href);
        url.searchParams.set('sort_by', this.value);
        window.location.href = url.toString();
      });

      // Set current sort value from URL
      const urlParams = new URLSearchParams(window.location.search);
      const currentSort = urlParams.get('sort_by');
      if (currentSort) {
        sortSelect.value = currentSort;
      }
    }

    // Apply filters on page load if needed
    applyFilters();
  })();
</script>

{%- paginate collection.products by section.settings.products_per_page -%}
{%- endpaginate -%}

{% schema %}
{
  "name": "Collection Product Grid",
  "settings": [
    {
      "type": "range",
      "id": "products_per_page",
      "min": 8,
      "max": 48,
      "step": 4,
      "label": "Products per page",
      "default": 16
    }
  ]
}
{% endschema %}
